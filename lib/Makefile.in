#
# Copyright (C) 2001 Sistina Software (UK) Limited.
#
# This file is released under the LGPL.
#

srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = @srcdir@
interface = @interface@

SOURCES=$(interface)/libdevmapper.c libdm-common.c

INCLUDES=-I$(interface)

TARGETS=$(interface)/libdevmapper.so

include ../make.tmpl


install: install_@interface@
	$(LN_S) -f libdevmapper.so.$(LIB_VERSION) $(libdir)/libdevmapper.so
	$(INSTALL) -D -o $(OWNER) -g $(GROUP) -m 444 libdevmapper.h \
		$(includedir)/libdevmapper.h

.PHONY: install install_@interface@

install_fs: fs/libdevmapper.so
	$(INSTALL) -D -o $(OWNER) -g $(GROUP) -m 555 $(STRIP) $< \
		$(libdir)/libdevmapper.so.$(LIB_VERSION)

install_ioctl: ioctl/libdevmapper.so
	$(INSTALL) -D -o $(OWNER) -g $(GROUP) -m 555 $(STRIP) $< \
		$(libdir)/libdevmapper.so.$(LIB_VERSION).$(IOCTL_VERSION)
	$(LN_S) -f libdevmapper.so.$(LIB_VERSION).$(IOCTL_VERSION) \
		 $(libdir)/libdevmapper.so.$(LIB_VERSION)

ioctl/libdevmapper.o: ioctl_version

ioctl_version: ioctl/libdevmapper.c
	@echo Checking library version compatible with kernel version in dm-ioctl.h
	test "$(IOCTL_VERSION)" = \
	     "$(shell $(CC) -E -dM $(INCLUDES) $(CFLAGS) \
	      ioctl/libdevmapper.c | \
	      awk -F '[ \t\"]+' '/DM_IOCTL_VERSION/ {print $$3}' )"

.PHONY: ioctl_version

